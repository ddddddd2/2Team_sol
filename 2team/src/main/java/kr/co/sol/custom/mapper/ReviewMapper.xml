<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.sol.custom.dao.ReviewDAO">
	<insert id="reviewInsert" parameterType="rdto">
		<selectKey keyProperty="no" resultType="int" order="BEFORE">
	       SELECT NVL(MAX(no),0)+1 no FROM review
      	</selectKey>
      	insert into 
      	review(no,res_no,mem_no,mem_id,date1,rating,file1,content)
      	values( #{no},
      			#{res_no},
      			#{mem_no},
      			#{mem_id},
      			sysdate,
      			#{rating},
      			#{file1},
      			#{content})
	</insert>
	
	
	<resultMap type="map" id="resultMap">
		<id column="count" property="count"/>
		<id column="avg"   property="avg"/>
	</resultMap>
	<select id="reviewCountAndAvg" parameterType="tdto" resultMap="resultMap">
		select count(*) count, nvl(trunc(avg(rating),1) , 0.0) avg 
		from review
		where res_no = #{no}
	</select>
	
	<select id="getReviews" parameterType="hashMap" resultType="rdto">
		select a.* 
		from(select rownum rr , b.*
			from ( select * 
				from review
					where res_no = #{no} 
					order by date1 desc) b ) a 
		<if test="start != null">
			where a.rr between #{start} and #{end}
		</if>
	</select>
	
	
	<insert id="likeReview" parameterType="hashMap">
      	insert into r_like(rev_no,mem_no)
      	values(#{rev_no},
      		   #{mem_no})
  	</insert>
  	
  	<delete id="dislikeReview" parameterType="hashMap">
  		delete from r_like 
  		where rev_no = #{rev_no}
  		and mem_no = #{mem_no}
  	</delete>
	
	<select id="likeCheck" parameterType="hashMap" resultType="int">
		select count(mem_no) 
  		from r_like 
  		where rev_no = #{rev_no}
  		and mem_no = #{mem_no}
	</select>
	
	<select id="likeCount">
		
	</select>
	
</mapper>